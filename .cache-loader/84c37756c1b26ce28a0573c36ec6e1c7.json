{"remainingRequest":"/Users/gabrielregis/react-spectrum-control-panel/node_modules/thread-loader/dist/cjs.js??ref--7-1!/Users/gabrielregis/react-spectrum-control-panel/node_modules/babel-loader/lib/index.js??ref--7-2!/Users/gabrielregis/react-spectrum-control-panel/src/services/websocket/websocket.ts","dependencies":[{"path":"/Users/gabrielregis/react-spectrum-control-panel/src/services/websocket/websocket.ts","mtime":1560467078000},{"path":"/Users/gabrielregis/react-spectrum-control-panel/node_modules/cache-loader/dist/cjs.js","mtime":1561315137663},{"path":"/Users/gabrielregis/react-spectrum-control-panel/node_modules/thread-loader/dist/cjs.js","mtime":1561315143281},{"path":"/Users/gabrielregis/react-spectrum-control-panel/node_modules/babel-loader/lib/index.js","mtime":1561315137554}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJhbnRkL2xpYi9tZXNzYWdlL3N0eWxlIjsKaW1wb3J0IF9tZXNzYWdlIGZyb20gImFudGQvbGliL21lc3NhZ2UiOwppbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudGVtaXR0ZXIzJzsKaW1wb3J0IHsgcmVhY3Rpb24gfSBmcm9tICdtb2J4JzsKaW1wb3J0IHsgc29ja2V0U3RvcmUgfSBmcm9tICdAc3RvcmUvaW5kZXgnOwp2YXIgcmVvcGVuVGltZXIgPSBudWxsOyAvLyDmmK/lkKbkuLvliqjmlq3lvIAKCnZhciBkaXNjb25uZWN0SW5pdGlhdGl2ZSA9IGZhbHNlOwoKLyoqCiAqIHNvY2tldCDpgJrkv6EKICoKICogQGV4cG9ydAogKiBAY2xhc3MgU29ja2V0CiAqLwpjbGFzcyBTb2NrZXQgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKTsKICAgIHRoaXMub25vcGVuID0gdm9pZCAwOwogICAgdGhpcy5vbm1lc3NhZ2UgPSB2b2lkIDA7CiAgICB0aGlzLmNvbm4gPSBudWxsOwogICAgdGhpcy5ydW4oKTsKICB9CgogIHJ1bigpIHsKICAgIHRoaXMub25vcGVuID0gKCkgPT4gewogICAgICB2YXIgdGV4dCA9ICdzb2NrZXQgY29ubmVjdGVkICEhISc7CiAgICAgIHNvY2tldFN0b3JlLnNldFNvY2tldElzQ29ubmVjdGVkKHRydWUpOwogICAgICBzb2NrZXRTdG9yZS5hZGRNZXNzYWdlKHsKICAgICAgICBldmVudDogJ2Nvbm5lY3QnLAogICAgICAgIGZyb206ICdjb25zb2xlJywKICAgICAgICBkYXRhOiB0ZXh0CiAgICAgIH0pOwogICAgfTsKCiAgICB0aGlzLm9ubWVzc2FnZSA9IG1zZyA9PiB7CiAgICAgIGlmICghbXNnIHx8ICFtc2cuZGF0YSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgc29ja2V0U3RvcmUuYWRkTWVzc2FnZSh7CiAgICAgICAgZXZlbnQ6ICdtZXNzYWdlJywKICAgICAgICBmcm9tOiAnc2VydmVyJywKICAgICAgICBkYXRhOiB0eXBlb2YgbXNnLmRhdGEgPT09ICdvYmplY3QnID8gSlNPTi5zdHJpbmdpZnkobXNnLmRhdGEpIDogbXNnLmRhdGEKICAgICAgfSk7CiAgICB9OwogIH0KCiAgc2VuZChkYXRhKSB7CiAgICB2YXIgcmV0cnkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IDA7CgogICAgaWYgKHRoaXMuY29ubiAmJiB0aGlzLmNvbm4ucmVhZHlTdGF0ZSA9PT0gdGhpcy5jb25uLk9QRU4pIHsKICAgICAgdGhpcy5jb25uLnNlbmQodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnID8gSlNPTi5zdHJpbmdpZnkoZGF0YSkgOiBkYXRhKTsKICAgIH0gZWxzZSBpZiAocmV0cnkgPCAzKSB7CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuc2VuZChkYXRhLCByZXRyeSsrKTsKICAgICAgfSwgMzAwKTsKICAgIH0KICB9CgogIG9wZW4odXJsKSB7CiAgICB0aGlzLmNvbm4gPSBuZXcgV2ViU29ja2V0KHVybCk7CgogICAgdGhpcy5jb25uLm9uY2xvc2UgPSBldnQgPT4gewogICAgICBzb2NrZXRTdG9yZS5zZXRTb2NrZXRJc0Nvbm5lY3RlZChmYWxzZSk7CiAgICAgIHZhciB0ZXh0ID0gYHNvY2tldCBjbG9zZTogJHt0eXBlb2YgZXZ0ID09PSAnb2JqZWN0JyA/IGV2dC5jb2RlIDogJyd9YDsKICAgICAgc29ja2V0U3RvcmUuYWRkTWVzc2FnZSh7CiAgICAgICAgZXZlbnQ6ICdjbG9zZScsCiAgICAgICAgZnJvbTogJ2NvbnNvbGUnLAogICAgICAgIGRhdGE6IHRleHQKICAgICAgfSk7CiAgICAgIGNsZWFyVGltZW91dChyZW9wZW5UaW1lcik7CgogICAgICBpZiAoIWRpc2Nvbm5lY3RJbml0aWF0aXZlKSB7CiAgICAgICAgcmVvcGVuVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aGlzLm9wZW4odXJsKTsKICAgICAgICB9LCAzMDAwKTsKICAgICAgfQoKICAgICAgZGlzY29ubmVjdEluaXRpYXRpdmUgPSBmYWxzZTsKICAgIH07CgogICAgdGhpcy5jb25uLm9uZXJyb3IgPSBldnQgPT4gewogICAgICBzb2NrZXRTdG9yZS5zZXRTb2NrZXRJc0Nvbm5lY3RlZChmYWxzZSk7CiAgICAgIHZhciB0ZXh0ID0gYHNvY2tldCBlcnJvcjogJHt0eXBlb2YgZXZ0ID09PSAnb2JqZWN0JyA/IEpTT04uc3RyaW5naWZ5KGV2dC5jb2RlKSA6ICcnfWA7CiAgICAgIHNvY2tldFN0b3JlLmFkZE1lc3NhZ2UoewogICAgICAgIGV2ZW50OiAnZXJyb3InLAogICAgICAgIGZyb206ICdjb25zb2xlJywKICAgICAgICBkYXRhOiB0ZXh0CiAgICAgIH0pOwogICAgfTsKCiAgICByZWFjdGlvbigoKSA9PiBzb2NrZXRTdG9yZS5zb2NrZXRUeXBlLCAoXywgcikgPT4gewogICAgICBjbGVhclRpbWVvdXQocmVvcGVuVGltZXIpOwogICAgICByLmRpc3Bvc2UoKTsKICAgIH0pOwoKICAgIGlmICh0aGlzLm9ub3BlbikgewogICAgICB0aGlzLmNvbm4ub25vcGVuID0gdGhpcy5vbm9wZW47CiAgICB9CgogICAgaWYgKHRoaXMub25tZXNzYWdlKSB7CiAgICAgIHRoaXMuY29ubi5vbm1lc3NhZ2UgPSB0aGlzLm9ubWVzc2FnZTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9Cgp9Cgp2YXIgc29ja2V0SW5zdGFuY2UgPSBuZXcgU29ja2V0KCk7CgpmdW5jdGlvbiBjYW5Tb2NrZXRPcGVuKCkgewogIHJldHVybiAhKHNvY2tldEluc3RhbmNlLmNvbm4gJiYgc29ja2V0SW5zdGFuY2UuY29ubi5yZWFkeVN0YXRlID09PSBzb2NrZXRJbnN0YW5jZS5jb25uLk9QRU4pOwp9CgpleHBvcnQgZnVuY3Rpb24gc29ja2V0Q29ubmVjdCh1cmwpIHsKICBpZiAoIWNhblNvY2tldE9wZW4oKSkgewogICAgcmV0dXJuIF9tZXNzYWdlLmVycm9yKCdQbGVhc2UgZGlzY29ubmVjdCB0aGUgZXhpc3RpbmcgaW5zdGFuY2UhISEnKTsKICB9CgogIHNvY2tldEluc3RhbmNlLm9wZW4odXJsKTsKfQpleHBvcnQgZnVuY3Rpb24gc29ja2V0RGlzY29ubmVjdCgpIHsKICBpZiAoc29ja2V0SW5zdGFuY2UuY29ubiAmJiBzb2NrZXRJbnN0YW5jZS5jb25uLnJlYWR5U3RhdGUgPT09IHNvY2tldEluc3RhbmNlLmNvbm4uT1BFTikgewogICAgc29ja2V0SW5zdGFuY2UuY29ubi5jbG9zZSgpOwogIH0KCiAgZGlzY29ubmVjdEluaXRpYXRpdmUgPSB0cnVlOwp9CmV4cG9ydCBmdW5jdGlvbiBzZW5kKF8sIGRhdGEpIHsKICBpZiAoIXNvY2tldEluc3RhbmNlLmNvbm4gJiYgc29ja2V0SW5zdGFuY2UuY29ubi5yZWFkeVN0YXRlICE9PSBzb2NrZXRJbnN0YW5jZS5jb25uLk9QRU4pIHsKICAgIHJldHVybiBfbWVzc2FnZS5lcnJvcignUGxlYXNlIGNvbm5lY3QgdG8gc2VydmVyISEhJyk7CiAgfQoKICBzb2NrZXRJbnN0YW5jZS5zZW5kKGRhdGEpOwogIHNvY2tldFN0b3JlLmFkZE1lc3NhZ2UoewogICAgZXZlbnQ6IG51bGwsCiAgICBmcm9tOiAnYnJvd3NlcicsCiAgICBkYXRhCiAgfSk7Cn0="},{"version":3,"sources":["/Users/gabrielregis/react-spectrum-control-panel/src/services/websocket/websocket.ts"],"names":["EventEmitter","reaction","socketStore","reopenTimer","disconnectInitiative","Socket","constructor","onopen","onmessage","conn","run","text","setSocketIsConnected","addMessage","event","from","data","msg","JSON","stringify","send","retry","readyState","OPEN","setTimeout","open","url","WebSocket","onclose","evt","code","clearTimeout","window","onerror","socketType","_","r","dispose","socketInstance","canSocketOpen","socketConnect","error","socketDisconnect","close"],"mappings":"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","sourcesContent":["import { EventEmitter } from 'eventemitter3'\nimport { message } from 'antd'\nimport { reaction } from 'mobx'\n\nimport { socketStore } from '@store/index'\n\nlet reopenTimer: number = null\n// 是否主动断开\nlet disconnectInitiative = false\n\ninterface SocketMsg {\n    data: any\n}\n\n/**\n * socket 通信\n *\n * @export\n * @class Socket\n */\nclass Socket extends EventEmitter {\n    onopen: () => void\n    onmessage: (msg: SocketMsg) => void\n    conn: WebSocket = null\n\n    constructor() {\n        super()\n        this.run()\n    }\n\n    run() {\n        this.onopen = () => {\n            const text = 'socket connected !!!'\n            socketStore.setSocketIsConnected(true)\n            socketStore.addMessage({\n                event: 'connect',\n                from: 'console',\n                data: text\n            })\n        }\n\n        this.onmessage = (msg: SocketMsg) => {\n            if (!msg || !msg.data) {\n                return\n            }\n            socketStore.addMessage({\n                event: 'message',\n                from: 'server',\n                data: typeof msg.data === 'object' ? JSON.stringify(msg.data) : msg.data\n            })\n        }\n    }\n\n    send(data: any, retry = 0) {\n        if (this.conn && this.conn.readyState === this.conn.OPEN) {\n            this.conn.send(typeof data === 'object' ? JSON.stringify(data) : data)\n        } else if (retry < 3) {\n            setTimeout(() => {\n                this.send(data, retry++)\n            }, 300)\n        }\n    }\n\n    open(url: string) {\n        this.conn = new WebSocket(url)\n        this.conn.onclose = evt => {\n            socketStore.setSocketIsConnected(false)\n            const text = `socket close: ${typeof evt === 'object' ? evt.code : ''}`\n            socketStore.addMessage({\n                event: 'close',\n                from: 'console',\n                data: text\n            })\n            clearTimeout(reopenTimer)\n            if (!disconnectInitiative) {\n                reopenTimer = window.setTimeout(() => {\n                    this.open(url)\n                }, 3000)\n            }\n            disconnectInitiative = false\n        }\n        this.conn.onerror = evt => {\n            socketStore.setSocketIsConnected(false)\n            const text = `socket error: ${typeof evt === 'object' ? JSON.stringify((evt as any).code) : ''}`\n            socketStore.addMessage({\n                event: 'error',\n                from: 'console',\n                data: text\n            })\n        }\n\n        reaction(\n            () => socketStore.socketType,\n            (_, r) => {\n                clearTimeout(reopenTimer)\n                r.dispose()\n            }\n        )\n\n        if (this.onopen) {\n            this.conn.onopen = this.onopen\n        }\n        if (this.onmessage) {\n            this.conn.onmessage = this.onmessage\n        }\n        return this\n    }\n}\n\nconst socketInstance = new Socket()\n\nfunction canSocketOpen() {\n    return !(socketInstance.conn && socketInstance.conn.readyState === socketInstance.conn.OPEN)\n}\n\nexport function socketConnect(url: string) {\n    if (!canSocketOpen()) {\n        return message.error('Please disconnect the existing instance!!!')\n    }\n    socketInstance.open(url)\n}\n\nexport function socketDisconnect() {\n    if (socketInstance.conn && socketInstance.conn.readyState === socketInstance.conn.OPEN) {\n        socketInstance.conn.close()\n    }\n    disconnectInitiative = true\n}\n\nexport function send(_, data: any) {\n    if (!socketInstance.conn && socketInstance.conn.readyState !== socketInstance.conn.OPEN) {\n        return message.error('Please connect to server!!!')\n    }\n    socketInstance.send(data)\n    socketStore.addMessage({\n        event: null,\n        from: 'browser',\n        data\n    })\n}\n"]}]}